<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Marker AR Chemistry Education System</title>

    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- AR.js with Marker Tracking Support -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        .a-canvas {
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #arContainer {
            width: 100%;
            height: 100vh;
        }

        #debugPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .parameter-display {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #00ff00;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <h2>Initializing AR Chemistry Lab...</h2>
        <p>Please allow camera access</p>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel">
        <strong>üîç Debug Info</strong>
        <div id="debugContent"></div>
    </div>

    <!-- A-Frame AR Scene -->
    <a-scene id="arScene" embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_PARITY65; sourceWidth:1280; sourceHeight:720; 
          displayWidth: 1280; displayHeight: 720;" vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true;">

        <!-- MAIN MARKER (Hiro Pattern - represents the chemistry apparatus) -->
        <!-- <a-marker 
            id="mainMarker"
            preset="hiro"
            emitevents="true"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"> -->
        <a-marker id="mainMarker" type="barcode" value="5" emitevents="true" smooth="true" smoothCount="8">
            <!-- Collider Area (Transparent green box for debugging) -->
            <!--  <a-box id="collider" width="1" height="1" depth="1" color="#00FF00" opacity="0.2" wireframe="true"
                position="0 0 0">
            </a-box>
        -->
            <!-- Main 3D Model Container -->
            <a-entity id="mainContent" position="0 0 0" scale="1 1 1">

                <!-- Tripod Stand (Snapped) -->
                <a-entity id="snappedStand" visible="false" scale="5 5 5" position="0 -0.5 0">
                    <a-entity gltf-model="Assets/Exothermic reaction/tripod_stand.glb"></a-entity>
                </a-entity>

                <!-- Pot (Snapped on top of stand) -->
                <a-entity id="snappedPot" visible="false" scale="0.001 0.001 0.001" position="0 0.1 0">
                    <a-entity gltf-model="Assets/Exothermic reaction/pot.glb"></a-entity>
                </a-entity>

                <!-- Central Molecule/Apparatus Structure (Original models, can be hidden if needed) -->
                <a-entity id="moleculeContainer" position="0 0.8 0" scale="1 1 1" visible="false">
                    <!-- Base platform -->
                    <a-cylinder id="basePlatform" radius="0.3" height="0.05" color="#333333" position="0 -0.2 0">
                    </a-cylinder>

                    <!-- Central container (beaker/flask)  -->
                    <a-cylinder id="mainContainer" radius="0.15" height="0.4" color="#4CAF50" opacity="0.7"
                        position="0 0 0">
                    </a-cylinder>

                    <!-- Liquid inside (will change color based on reactions) -->
                    <a-cylinder id="liquidContent" radius="0.12" height="0.3" color="#2196F3" opacity="0.8"
                        position="0 -0.05 0">
                    </a-cylinder>

                    <!-- Heating element (burner) -->
                    <a-cone id="burner" radius-bottom="0.12" radius-top="0.08" height="0.1" color="#FF6F00"
                        opacity="0.6" position="0 -0.25 0">
                    </a-cone>

                    <!-- Thermometer -->
                    <a-cylinder id="thermometer" radius="0.02" height="0.3" color="#FF4444" position="0.2 0 0">
                    </a-cylinder>

                    <!-- Stirrer -->
                    <a-cylinder id="stirrer" radius="0.01" height="0.35" color="#CCCCCC" position="-0.15 0 0">
                    </a-cylinder>
                </a-entity>

                <!-- Temperature indicator -->
                <a-text id="tempText" value="25¬∞C" color="#FF4444" position="0 1.25 0" scale="0.15 0.15 0.15"
                    align="center">
                </a-text>

                <!-- Main marker label -->
                <a-text value="Chemistry Lab" color="#00FF00" position="0 -0.45 0" scale="0.1 0.1 0.1" align="center">
                </a-text>
            </a-entity>
        </a-marker>

        <!-- EVENT MARKER 1: HEAT (Barcode 0) -->
        <a-marker id="heatMarker" type="barcode" value="0" emitevents="true" smooth="true" smoothCount="8">

            <a-entity position="0 0 0" scale="3 3 3">

                <!-- Gas Lighter GLB Model -->
                <a-entity gltf-model="Assets/Exothermic reaction/gas_lighter.glb" position="0 0 0" rotation="0 0 0">
                </a-entity>

                <a-text value="üî• HEAT" color="#FFFFFF" position="0 0.5 0" scale="0.2 0.2 0.2" align="center">
                </a-text>
            </a-entity>
        </a-marker>

        <!-- EVENT MARKER 2: POT (Barcode 1) -->
        <a-marker id="potMarker" type="barcode" value="1" emitevents="true" smooth="true" smoothCount="8">

            <a-entity id="potOriginalModel" position="0 0 0" scale="0.001 0.001 0.001">

                <!-- Pot GLB Model -->
                <a-entity gltf-model="Assets/Exothermic reaction/pot.glb" position="0 0 0" rotation="0 0 0">
                </a-entity>

                <a-text value="POT" color="#FFFFFF" position="0 0.5 0" scale="300 300 300" align="center">
                </a-text>
            </a-entity>
        </a-marker>

        <!-- EVENT MARKER 3: REAGENT (Barcode 2) -->
        <a-marker id="sandBoxMarker" type="barcode" value="2" emitevents="true" smooth="true" smoothCount="8">

            <a-entity position="0 0 0" scale="5 5 5">

                <!-- Sand Box GLB Model -->
                <a-entity gltf-model="Assets/Exothermic reaction/sand_box.glb" position="0 0 0" rotation="0 0 0">
                </a-entity>

                <a-text value="üß¨ REAGENT" color="#FFFFFF" position="0 0.5 0" scale="0.15 0.15 0.15" align="center">
                </a-text>
            </a-entity>
        </a-marker>

        <!-- EVENT MARKER 4: TRIPOD STAND (Barcode 3) -->
        <a-marker id="tripodStandMarker" type="barcode" value="3" emitevents="true" smooth="true" smoothCount="8">

            <a-entity id="standOriginalModel" position="0 0 0" scale="5 5 5">

                <!-- Tripod Stand GLB Model -->
                <a-entity gltf-model="Assets/Exothermic reaction/tripod_stand.glb" position="0 0 0" rotation="0 0 0">
                </a-entity>

                <a-text value="TRIPOD" color="#FFFFFF" position="0 0.5 0" scale="0.2 0.2 0.2" align="center">
                </a-text>
            </a-entity>
        </a-marker>

        <!-- Camera -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const experimentState = {
            temperature: 25,
            isHeating: false,
            isStirring: false,
            modelRotation: 0,
            activeMarkers: new Set(),
            liquidColor: '#2196F3',
            containerColor: '#4CAF50',
            isStandAttached: false,
            isPotAttached: false,
            proximityThreshold: 4.0 // Distance threshold for snapping
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ AR Chemistry Lab Initializing...');

            // Hide loading screen after AR scene loads
            const scene = document.getElementById('arScene');
            scene.addEventListener('loaded', () => {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 2000);
            });

            // Setup marker event listeners
            setupMarkerEventListeners();

            // Start animation loop
            animationLoop();

            // Update debug info
            updateDebugInfo();
        });

        // ============================================
        // MARKER EVENT SETUP
        // ============================================
        function setupMarkerEventListeners() {
            // Main marker events
            const mainMarker = document.getElementById('mainMarker');
            mainMarker.addEventListener('markerFound', () => {
                console.log('‚úÖ Main marker detected');
                experimentState.activeMarkers.add('main');
                updateDebugInfo();
            });
            mainMarker.addEventListener('markerLost', () => {
                console.log('‚ùå Main marker lost');
                experimentState.activeMarkers.delete('main');
                updateDebugInfo();
            });

            // Heat marker events
            const heatMarker = document.getElementById('heatMarker');
            heatMarker.addEventListener('markerFound', () => {
                console.log('üî• Heat marker detected - Activating burner');
                activateHeatEvent();
            });
            heatMarker.addEventListener('markerLost', () => {
                console.log('Heat marker lost');
                deactivateHeatEvent();
            });

            // Pot marker events
            const potMarker = document.getElementById('potMarker');
            potMarker.addEventListener('markerFound', () => {
                console.log('Pot marker detected');
                experimentState.activeMarkers.add('pot');
                updateDebugInfo();
            });
            potMarker.addEventListener('markerLost', () => {
                console.log('Pot marker lost');
                experimentState.activeMarkers.delete('pot');
                updateDebugInfo();
            });

            // Reagent marker events
            const sandBoxMarker = document.getElementById('sandBoxMarker');
            sandBoxMarker.addEventListener('markerFound', () => {
                console.log('üß¨ Reagent marker detected - Adding reagent');
                experimentState.activeMarkers.add('reagent');
                activateReagentEvent();
            });
            sandBoxMarker.addEventListener('markerLost', () => {
                console.log('Reagent marker lost');
                experimentState.activeMarkers.delete('reagent');
            });

            // Tripod marker events
            const tripodStandMarker = document.getElementById('tripodStandMarker');
            tripodStandMarker.addEventListener('markerFound', () => {
                console.log('Tripod marker detected');
                experimentState.activeMarkers.add('stand');
                updateDebugInfo();
            });
            tripodStandMarker.addEventListener('markerLost', () => {
                console.log('Tripod marker lost');
                experimentState.activeMarkers.delete('stand');
                updateDebugInfo();
            });
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        function activateHeatEvent() {
            experimentState.isHeating = true;
            experimentState.activeMarkers.add('heat');
            document.getElementById('activeEventsCount').textContent = experimentState.activeMarkers.size;
            console.log('üî• Heating started - Temperature increasing');
        }

        function deactivateHeatEvent() {
            experimentState.isHeating = false;
            experimentState.activeMarkers.delete('heat');
            document.getElementById('activeEventsCount').textContent = experimentState.activeMarkers.size;
            console.log('üî• Heating stopped');
        }

        function activateStirEvent() {
            experimentState.isStirring = true;
            experimentState.activeMarkers.add('stir');
            document.getElementById('activeEventsCount').textContent = experimentState.activeMarkers.size;
            console.log('üîÑ Stirring started');
        }

        function deactivateStirEvent() {
            experimentState.isStirring = false;
            experimentState.activeMarkers.delete('stir');
            document.getElementById('activeEventsCount').textContent = experimentState.activeMarkers.size;
            console.log('üîÑ Stirring stopped');
        }

        function activateReagentEvent() {
            // Change liquid color (simulate reaction)
            const colors = ['#FF1744', '#FF5722', '#FFD700', '#4CAF50', '#2196F3'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            experimentState.liquidColor = randomColor;

            const liquid = document.getElementById('liquidContent');
            if (liquid) {
                liquid.setAttribute('color', randomColor);
            }

            console.log('üß¨ Reagent added - Color changed to', randomColor);
        }

        // ============================================
        // ANIMATION LOOP
        // ============================================
        function animationLoop() {
            const mainMarker = document.getElementById('mainMarker');
            const standMarker = document.getElementById('tripodStandMarker');
            const potMarker = document.getElementById('potMarker');

            // 1. Proximity Check
            if (experimentState.activeMarkers.has('main')) {
                const mainPos = new THREE.Vector3();
                mainMarker.object3D.getWorldPosition(mainPos);
                experimentState.mainPos = mainPos; // Save for debug

                // Check Stand proximity
                if (experimentState.activeMarkers.has('stand') && !experimentState.isStandAttached) {
                    const standPos = new THREE.Vector3();
                    standMarker.object3D.getWorldPosition(standPos);
                    experimentState.standPos = standPos; // Save for debug

                    // 3D Distance for debugging
                    const dist3D = mainPos.distanceTo(standPos);

                    // 2D distance calculation (ignore Y/height differences)
                    const dx = mainPos.x - standPos.x;
                    const dz = mainPos.z - standPos.z;
                    const dist2D = Math.sqrt(dx * dx + dz * dz);

                    experimentState.lastStandDist = dist2D;
                    experimentState.lastStandDist3D = dist3D;

                    if (dist2D < experimentState.proximityThreshold) {
                        console.log('üß≤ Stand Snapped!');
                        experimentState.isStandAttached = true;
                        document.getElementById('snappedStand').setAttribute('visible', 'true');
                        document.getElementById('standOriginalModel').setAttribute('visible', 'false');
                    }
                }

                // Check Pot proximity (requires stand to be attached)
                if (experimentState.activeMarkers.has('pot') && experimentState.isStandAttached && !experimentState.isPotAttached) {
                    const potPos = new THREE.Vector3();
                    potMarker.object3D.getWorldPosition(potPos);
                    experimentState.potPos = potPos; // Save for debug

                    // 3D Distance for debugging
                    const dist3D = mainPos.distanceTo(potPos);

                    // 2D distance calculation
                    const dx = mainPos.x - potPos.x;
                    const dz = mainPos.z - potPos.z;
                    const dist2D = Math.sqrt(dx * dx + dz * dz);

                    experimentState.lastPotDist = dist2D;
                    experimentState.lastPotDist3D = dist3D;

                    if (dist2D < experimentState.proximityThreshold) {
                        console.log('üß≤ Pot Snapped!');
                        experimentState.isPotAttached = true;
                        document.getElementById('snappedPot').setAttribute('visible', 'true');
                        document.getElementById('potOriginalModel').setAttribute('visible', 'false');
                    }
                }
            }

            // Update temperature when heating
            if (experimentState.isHeating) {
                experimentState.temperature = Math.min(experimentState.temperature + 2, 100);
            } else if (experimentState.temperature > 25) {
                experimentState.temperature = Math.max(experimentState.temperature - 1, 25);
            }

            // Update burner color based on temperature
            const burner = document.getElementById('burner');
            if (burner) {
                const heat = experimentState.temperature / 100;
                if (heat > 0.3) {
                    burner.setAttribute('opacity', 0.3 + heat * 0.6);
                }
            }

            // Update temperature display
            document.getElementById('tempText').setAttribute('value', Math.round(experimentState.temperature) + '¬∞C');

            // Update stirring rotation
            if (experimentState.isStirring) {
                experimentState.modelRotation = (experimentState.modelRotation + 4) % 360;

                const moleculeContainer = document.getElementById('moleculeContainer');
                if (moleculeContainer) {
                    moleculeContainer.setAttribute('rotation', `0 ${experimentState.modelRotation} 0`);
                }

                // Rotate stirrer
                const stirrer = document.getElementById('stirrer');
                if (stirrer) {
                    stirrer.setAttribute('rotation', `0 ${experimentState.modelRotation} 0`);
                }
            }

            updateDebugInfo();
            requestAnimationFrame(animationLoop);
        }

        // ============================================
        // UI UTILITIES
        // ============================================
        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');

            const formatPos = (pos) => pos ? `${pos.x.toFixed(1)}, ${pos.y.toFixed(1)}, ${pos.z.toFixed(1)}` : 'n/a';

            debugContent.innerHTML = `
                <div style="margin-top: 8px; font-size: 10px;">
                    <div>MainPos: ${formatPos(experimentState.mainPos)}</div>
                    <div>StandPos: ${formatPos(experimentState.standPos)}</div>
                    <hr style="margin: 5px 0; opacity: 0.3;">
                    <div style="color: yellow;">Distances (2D / 3D):</div>
                    <div>Stand: ${experimentState.lastStandDist ? experimentState.lastStandDist.toFixed(2) : '--'} / ${experimentState.lastStandDist3D ? experimentState.lastStandDist3D.toFixed(2) : '--'}</div>
                    <div>Pot: ${experimentState.lastPotDist ? experimentState.lastPotDist.toFixed(2) : '--'} / ${experimentState.lastPotDist3D ? experimentState.lastPotDist3D.toFixed(2) : '--'}</div>
                    <hr style="margin: 5px 0; opacity: 0.3;">
                    <div>Status: ${experimentState.isStandAttached ? 'Stand ‚úÖ' : 'Stand ‚ùå'} | ${experimentState.isPotAttached ? 'Pot ‚úÖ' : 'Pot ‚ùå'}</div>
                </div>
            `;
        }

        function toggleDebugMode() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        function resetExperiment() {
            experimentState.temperature = 25;
            experimentState.isHeating = false;
            experimentState.isStirring = false;
            experimentState.modelRotation = 0;
            experimentState.activeMarkers.clear();
            experimentState.liquidColor = '#2196F3';

            const liquid = document.getElementById('liquidContent');
            if (liquid) {
                liquid.setAttribute('color', '#2196F3');
            }

            const moleculeContainer = document.getElementById('moleculeContainer');
            if (moleculeContainer) {
                moleculeContainer.setAttribute('rotation', '0 0 0');
            }

            document.getElementById('activeEventsCount').textContent = '0';
            document.getElementById('tempDisplay').textContent = '25¬∞C';
            document.getElementById('rotationDisplay').textContent = '0¬∞';

            console.log('üîÑ Experiment reset');
        }

        function downloadMarkers() {
            alert(`üì• Marker Generation Guide:

MAIN MARKER (2/3 of A3 Sheet):
1. Download HIRO marker from:
   https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/HIRO.png
2. Print at high quality (at least 300 DPI)
3. Mount on foam board or cardboard

EVENT MARKERS (Trump Cards):
These use barcode markers (0-3). You can generate them using:
1. Visit: https://chev.github.io/opentag/
2. Generate barcode patterns
3. Print on regular cardstock
4. Mount on trump cards

Marker Values:
‚Ä¢ Barcode 0: HEAT marker
‚Ä¢ Barcode 1: STIR marker
‚Ä¢ Barcode 2: REAGENT marker
‚Ä¢ Barcode 3: COOL marker

Tips:
‚úì Use high contrast printing
‚úì Mount on rigid surfaces
‚úì Minimum marker size: 5cm x 5cm
‚úì Good lighting improves detection`);
        }
    </script>
</body>

</html>